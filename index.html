<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DoIT Communications UTM Link Builder - Create tracking links for various communication channels">
    <title>DoIT Communications UTM Link Builder</title>
    <link rel="preload" href="https://cdn.wisc.cloud/fonts/uw-rh/0.0.1/redhat-display-latin.v14.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="https://cdn.wisc.cloud/fonts/uw-rh/0.0.1/redhat-text-latin.v13.woff2" as="font" type="font/woff2" crossorigin>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'')})(document.documentElement)</script>
    <link rel="dns-prefetch" href="https://wisc.edu">
    <meta name="theme-color" content="#c5050c">
    
    <!-- UW Templates and Styles -->
    <link rel="stylesheet" crossorigin type="text/css" href="https://cdn.wisc.cloud/fonts/uw-rh/0.0.1/fonts.css" />
    <link rel="stylesheet" href="https://it.wisc.edu/wp-content/themes/uw-theme/dist/main.min.css">
    
    <!-- Favicons - using only basic favicon to avoid CORS issues -->
    <link rel="shortcut icon" href="https://it.wisc.edu/favicon.ico">
    <link rel="icon" href="https://it.wisc.edu/favicon.ico">
    
    <style>
        :root {
            --primary-color: #c5050c;
            --primary-hover: #990000;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --secondary-btn-color: #666;
            --text-color: #333;
            --spacing-unit: 10px;
            --gray-bg: #f0f0f0;
        }
        
        .uw-body {
            max-width: 1000px;
            margin: 0 auto;
            padding: 15px;
            color: var(--text-color);
            line-height: 1.4;
        }
        
        .form-group { 
            margin-bottom: 15px; 
        }
        
        /* Adjust main content padding for more compact layout */
        .uw-pad-xl {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }
        
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        
        .checkbox-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: var(--spacing-unit); 
            margin-bottom: 10px; 
        }
        
        .optional-params-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-unit);
            margin-bottom: 10px;
        }
        
        fieldset {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        /* For desktop screens, use more columns to reduce vertical space */
        /* Desktop layout optimizations to reduce vertical space */
        @media (min-width: 900px) {
            .checkbox-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .desktop-layout {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .channel-columns {
                flex: 3;
                min-width: 600px;
            }
            
            .params-column {
                flex: 1;
                min-width: 250px;
            }
            
            .params-column {
                display: flex;
                flex-direction: column;
            }
            
            .button-container {
                margin-top: 10px;
                margin-bottom: 10px;
            }
            
            /* On desktop, push button to bottom of params column */
            @media (min-width: 1000px) {
                .params-column {
                    height: 100%;
                }
                
                .button-container {
                    margin-top: auto;
                }
            }
            
            .optional-params-grid {
                display: block;
            }
            
            /* Smaller checkbox text for more compact display */
            .checkbox-item label {
                font-size: 0.9em;
            }
        }
        
        legend {
            padding: 0 8px;
        }
        
        legend h3 {
            margin: 0;
            font-size: 1.1em;
        }
        
        .param-item label {
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .param-item input {
            margin-bottom: calc(var(--spacing-unit) / 2);
        }
        
        .optional-params-grid .param-item {
            position: relative;
        }
        
        @media (max-width: 600px) {
            .checkbox-grid, .optional-params-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 400px) {
            .checkbox-grid, .optional-params-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .checkbox-item { 
            display: flex; 
            align-items: center; 
            margin-bottom: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        input[type="text"] { 
            width: 100%; 
            padding: 8px; 
            margin-bottom: var(--spacing-unit); 
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 1px;
        }
        
        button { 
            padding: 10px 15px; 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 4px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover, button:focus { 
            background: var(--primary-hover); 
        }
        
        button:focus {
            outline: 2px solid var(--primary-hover);
            outline-offset: 2px;
        }
        
        .result { 
            margin-top: 15px; 
            padding: 15px; 
            background: var(--light-bg); 
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .copy-btn { 
            background: var(--secondary-btn-color); 
            margin-left: var(--spacing-unit); 
            font-size: 12px; 
            padding: 3px 8px; 
        }
        
        .instructions { 
            background: var(--light-bg); 
            padding: 10px 15px; 
            margin-bottom: 15px; 
            border-left: 4px solid var(--primary-color);
            border-radius: 0 4px 4px 0;
        }
        
        /* Make headings and legends more compact */
        .uw-mini-bar {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }
        
        legend h3 {
            font-size: 1em !important;
        }
        
        .error-text {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        .note {
            font-size: 0.8em;
            color: #666;
            font-weight: normal;
        }
        
        #results button.reset-btn {
            margin-bottom: 20px;
        }
        
        .results-container {
            display: grid;
            gap: 20px;
        }
        
        .url-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .url-input {
            flex: 1;
            font-family: monospace;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .copy-all-btn {
            margin-bottom: 20px;
        }
        
        .utm-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            border-left: 4px solid #ffeeba;
            margin-bottom: 15px;
        }
        
        /* Link History Styles */
        #linkHistory {
            margin-top: 30px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .history-header {
            background-color: var(--gray-bg);
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .history-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .history-content.open {
            max-height: 100vh;
            overflow-y: auto;
        }
        
        .history-entry {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-entry:last-child {
            border-bottom: none;
        }
        
        .history-entry .url-container {
            margin-top: 5px;
        }
        
        .history-meta {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .clear-history-btn {
            background: var(--secondary-btn-color);
            margin-left: auto;
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        
        /* New Domain-based History Styles */
        .domain-groups {
            width: 100%;
        }
        
        .domain-section {
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .domain-header {
            background-color: var(--primary-color);
            color: white;
            margin: 0;
            padding: 8px 15px;
            font-size: 1.1rem;
        }
        
        .domain-entries {
            border-top: 1px solid var(--border-color);
        }
        
        .path-info {
            font-weight: bold;
            margin: 5px 0;
            font-size: 0.95rem;
            word-break: break-all;
        }
        
        .campaign-info {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #444;
        }
        
        .expand-links-btn {
            background-color: #e0e0e0;
            color: #333;
            font-size: 0.8rem;
            padding: 4px 8px;
            margin: 5px 0;
            border-radius: 3px;
        }
        
        .expand-links-btn:hover, .expand-links-btn:focus {
            background-color: #c5c5c5;
        }
        
        .links-container {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dotted var(--border-color);
        }
        
        .links-container .url-container {
            margin: 5px 0;
            padding: 5px;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        
        @media (prefers-reduced-motion: reduce) {
            button, .history-content {
                transition: none;
            }
        }
    </style>
</head>
<body>
    <a class="uw-show-on-focus" href="#main" id="uw-skip-link">Skip to main content</a>
    <div class="uw-global-bar" role="navigation">
        <a class="uw-global-name-link" href="https://www.wisc.edu" aria-label="University home page">U<span>niversity <span class="uw-of">of</span> </span>W<span>isconsin</span>â€“Madison</a>
    </div>
    
    <header id="branding" class="uw-header">
        <div class="uw-header-container">
            <div class="uw-header-crest-title">
                <div class="uw-header-crest">
                    <a href="https://www.wisc.edu"><img class="uw-crest-svg" src="https://it.wisc.edu/wp-content/themes/uw-theme/dist/images/uw-crest.svg" alt="Link to University of Wisconsin-Madison home page"></a>
                </div>
                <div class="uw-title-tagline">
                    <h1 id="site-title" class="uw-site-title">
                        <a href="" rel="home">DoIT Communications</a>
                    </h1>
                    <div id="site-description" class="uw-site-tagline">UTM Link Builder Tool</div>
                </div>
            </div>
        </div>
    </header>
    
    <main class="uw-pad-xl" id="main">
        <div class="uw-body">
            <h2 class="uw-mini-bar">UTM Link Builder Tool</h2>
            
            <div class="instructions">
                Enter a URL, select distribution channels, add optional parameters, and click "Generate UTM Links" to create tracking links.
            </div>
    
    <form id="formContainer">
        <div class="form-group">
            <label for="baseUrl">Website URL<span aria-hidden="true">*</span><span class="sr-only">(required)</span></label>
            <input type="text" id="baseUrl" name="baseUrl" placeholder="https://example.wisc.edu" aria-required="true" autocomplete="url">
        </div>
        
        <div class="desktop-layout">
            <!-- Distribution Channels -->
            <div class="form-group channel-columns">
                <fieldset>
                    <legend><h3>DoIT Channels</h3></legend>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="doitnet" name="channels" data-medium="referral">
                            <label for="doitnet">DoITnet</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="it_news" name="channels" data-medium="referral">
                            <label for="it_news">IT News</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doit_connection" name="channels" data-medium="email">
                            <label for="doit_connection">DoIT Connection</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doit_technews_facstaff" name="channels" data-medium="email">
                            <label for="doit_technews_facstaff">TechNews (Faculty/Staff)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doit_technews_students" name="channels" data-medium="email">
                            <label for="doit_technews_students">TechNews (Students)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doit_linkedin" name="channels" data-medium="social">
                            <label for="doit_linkedin">DoIT LinkedIn</label>
                        </div>
                    </div>
                </fieldset>
                
                <fieldset>
                    <legend><h3>University Tools</h3></legend>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="eloqua" name="channels" data-medium="email">
                            <label for="eloqua">Eloqua <span class="note">(non-TechNews/Connection)</span></label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="go_wisc_edu" name="channels" data-medium="referral">
                            <label for="go_wisc_edu">go.wisc.edu</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="lighthouse_letters" name="channels" data-medium="email">
                            <label for="lighthouse_letters">Lighthouse Letters</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="qrcode" name="channels" data-medium="referral">
                            <label for="qrcode">QR code</label>
                        </div>
                    </div>
                </fieldset>
                
                <fieldset>
                    <legend><h3>Partners</h3></legend>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="ctlm" name="channels" data-medium="referral">
                            <label for="ctlm">CTLM</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="planners_picks" name="channels" data-medium="email">
                            <label for="planners_picks">Planners Picks</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="smph_in_the_know" name="channels" data-medium="email">
                            <label for="smph_in_the_know">SMPH In the Know</label>
                        </div>
                    </div>
                </fieldset>
            </div>
            
            <!-- Optional Parameters -->
            <div class="form-group params-column">
                <fieldset>
                    <legend><h3>Optional Parameters</h3></legend>
                    <div class="optional-params-grid">
                        <div class="param-item">
                            <label for="campaign">Campaign</label>
                            <input type="text" id="campaign" name="campaign" placeholder="e.g., spring_campaign">
                        </div>
                        
                        <div class="param-item">
                            <label for="term">Term</label>
                            <input type="text" id="term" name="term" placeholder="e.g., keyword">
                        </div>
                        
                        <div class="param-item">
                            <label for="content">Content</label>
                            <input type="text" id="content" name="content" placeholder="e.g., button, banner">
                        </div>
                    </div>
                </fieldset>
                
                <div class="button-container">
                    <button id="generateBtn" type="button" aria-label="Generate UTM Links for selected channels">Generate UTM Links</button>
                </div>
            </div>
        </div>
    </form>
    
    <div id="errorMessages" class="error-text" role="alert" aria-live="assertive"></div>
    
    <div id="results" aria-live="polite"></div>
    
    <!-- Link History Section -->
    <div id="linkHistory">
        <div class="history-header">
            <h2>Link History (Grouped by Domain)</h2>
            <button id="clearHistoryBtn" class="clear-history-btn">Clear History</button>
        </div>
        <div class="history-content" id="historyContent">
            <!-- History entries will be dynamically added here grouped by domain -->
        </div>
    </div>
        </div>
    </main>
    <!-- We're removing the UW theme scripts since they're causing 404 errors -->
    <!-- The visual styling from UW theme CSS will still be applied -->
    
    <script defer>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const formEl = document.getElementById('formContainer');
            const baseUrlInput = document.getElementById('baseUrl');
            const campaignInput = document.getElementById('campaign');
            const termInput = document.getElementById('term');
            const contentInput = document.getElementById('content');
            const generateBtn = document.getElementById('generateBtn');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('errorMessages');
            const historyHeader = document.querySelector('.history-header');
            const historyContent = document.getElementById('historyContent');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            
            // Copy text to clipboard with modern API and fallback
            function copyToClipboard(text, button) {
                // Try to use modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            button.textContent = 'Copied!';
                            setTimeout(() => { button.textContent = 'Copy'; }, 2000);
                        })
                        .catch(() => {
                            // Fall back to deprecated method
                            fallbackCopy(text, button);
                        });
                } else {
                    // Fall back to deprecated method
                    fallbackCopy(text, button);
                }
            }

            // Fallback copy method for older browsers
            function fallbackCopy(text, button) {
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = text;
                tempTextarea.setAttribute('readonly', '');
                tempTextarea.style.position = 'absolute';
                tempTextarea.style.left = '-9999px';
                document.body.appendChild(tempTextarea);
                
                // Check if we're on iOS
                const isIOS = navigator.userAgent.match(/ipad|iphone/i);
                
                if (isIOS) {
                    // Create a range and select the text
                    const range = document.createRange();
                    range.selectNodeContents(tempTextarea);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    tempTextarea.setSelectionRange(0, 999999);
                } else {
                    tempTextarea.select();
                }
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        button.textContent = 'Copied!';
                        setTimeout(() => { button.textContent = 'Copy'; }, 2000);
                    } else {
                        button.textContent = 'Error!';
                    }
                } catch (err) {
                    button.textContent = 'Error!';
                    console.error('Copy failed:', err);
                }
                
                document.body.removeChild(tempTextarea);
            }
            
            // Link History Functions
            function saveToHistory(links) {
                // Get existing history or initialize empty array
                let history = JSON.parse(localStorage.getItem('utmLinkHistory') || '[]');
                
                // Add new entry with timestamp
                const entry = {
                    timestamp: new Date().toISOString(),
                    baseUrl: baseUrlInput.value.trim(),
                    campaign: campaignInput.value.trim(),
                    term: termInput.value.trim(),
                    content: contentInput.value.trim(),
                    links: links
                };
                
                // Add to beginning of array (most recent first)
                history.unshift(entry);
                
                // Limit history to 50 entries
                if (history.length > 50) {
                    history = history.slice(0, 50);
                }
                
                // Save back to localStorage
                localStorage.setItem('utmLinkHistory', JSON.stringify(history));
                
                // Update history display
                displayHistory();
            }
            
            // Extract domain name from URL
            function extractDomain(url) {
                try {
                    const urlObj = new URL(url);
                    return urlObj.hostname;
                } catch (e) {
                    // If URL parsing fails, try a simple regex extraction
                    const match = url.match(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n?]+)/im);
                    return match ? match[1] : '';
                }
            }
            
            // Group entries by domain
            function groupEntriesByDomain(history) {
                const domainGroups = {};
                
                history.forEach(entry => {
                    // Get base domain from URL
                    const domain = extractDomain(entry.baseUrl);
                    
                    // Initialize domain group if it doesn't exist
                    if (!domainGroups[domain]) {
                        domainGroups[domain] = [];
                    }
                    
                    // Add entry to its domain group
                    domainGroups[domain].push(entry);
                });
                
                return domainGroups;
            }
            
            function displayHistory() {
                // Get history from localStorage
                const history = JSON.parse(localStorage.getItem('utmLinkHistory') || '[]');
                
                // Clear current history content
                historyContent.innerHTML = '';
                
                if (history.length === 0) {
                    // No history yet
                    historyContent.innerHTML = '<div class="history-entry"><p>No link history yet.</p></div>';
                    return;
                }
                
                // Group entries by domain
                const domainGroups = groupEntriesByDomain(history);
                
                // Create a container for domains
                const domainsContainer = document.createElement('div');
                domainsContainer.className = 'domain-groups';
                
                // Process each domain group
                Object.entries(domainGroups).forEach(([domain, entries]) => {
                    // Create domain section
                    const domainSection = document.createElement('div');
                    domainSection.className = 'domain-section';
                    
                    // Create domain header
                    const domainHeader = document.createElement('h3');
                    domainHeader.className = 'domain-header';
                    domainHeader.textContent = domain;
                    domainSection.appendChild(domainHeader);
                    
                    // Create entries container for this domain
                    const entriesContainer = document.createElement('div');
                    entriesContainer.className = 'domain-entries';
                    
                    // Add each entry for this domain
                    entries.forEach(entry => {
                        // Create entry row
                        const entryRow = document.createElement('div');
                        entryRow.className = 'history-entry';
                        
                        // Format timestamp
                        const date = new Date(entry.timestamp);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        // Create metadata with timestamp
                        const meta = document.createElement('div');
                        meta.className = 'history-meta';
                        meta.textContent = `Created: ${formattedDate}`;
                        
                        // Create path info (excluding domain)
                        let path = '';
                        try {
                            const urlObj = new URL(entry.baseUrl);
                            path = urlObj.pathname + urlObj.search + urlObj.hash;
                        } catch (e) {
                            path = entry.baseUrl.split(domain)[1] || '';
                        }
                        
                        const pathInfo = document.createElement('div');
                        pathInfo.className = 'path-info';
                        pathInfo.textContent = path || '/';
                        
                        // Create campaign info if available
                        let campaignInfo = '';
                        if (entry.campaign) campaignInfo = `Campaign: ${entry.campaign}`;
                        if (entry.term) campaignInfo += campaignInfo ? `, Term: ${entry.term}` : `Term: ${entry.term}`;
                        if (entry.content) campaignInfo += campaignInfo ? `, Content: ${entry.content}` : `Content: ${entry.content}`;
                        
                        const campaignElem = document.createElement('p');
                        campaignElem.className = 'campaign-info';
                        campaignElem.textContent = campaignInfo || 'No additional parameters';
                        
                        // Create expand button to show/hide links
                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-links-btn';
                        expandBtn.textContent = 'Show Links';
                        expandBtn.setAttribute('aria-expanded', 'false');
                        
                        // Create links container
                        const linksContainer = document.createElement('div');
                        linksContainer.className = 'links-container';
                        linksContainer.style.display = 'none';
                        
                        // Add all links for this entry
                        entry.links.forEach(link => {
                            // Container for link
                            const linkContainer = document.createElement('div');
                            linkContainer.className = 'url-container';
                            
                            // Source info
                            const sourceInfo = document.createElement('p');
                            sourceInfo.innerHTML = `<strong>${link.publication}</strong>`;
                            
                            // URL input
                            const urlText = document.createElement('input');
                            urlText.type = 'text';
                            urlText.value = link.url;
                            urlText.readOnly = true;
                            urlText.className = 'url-input';
                            urlText.setAttribute('aria-label', `URL for ${link.publication}`);
                            
                            // Add click handler to select all text
                            urlText.addEventListener('click', function() {
                                this.select();
                            });
                            
                            // Copy button
                            const copyBtn = document.createElement('button');
                            copyBtn.textContent = 'Copy';
                            copyBtn.className = 'copy-btn';
                            copyBtn.setAttribute('aria-label', `Copy URL for ${link.publication} to clipboard`);
                            copyBtn.addEventListener('click', function() {
                                copyToClipboard(link.url, this);
                            });
                            
                            linkContainer.appendChild(sourceInfo);
                            linkContainer.appendChild(urlText);
                            linkContainer.appendChild(copyBtn);
                            
                            linksContainer.appendChild(linkContainer);
                        });
                        
                        // Toggle links visibility on expand button click
                        expandBtn.addEventListener('click', function() {
                            const isExpanded = this.getAttribute('aria-expanded') === 'true';
                            this.setAttribute('aria-expanded', !isExpanded);
                            this.textContent = isExpanded ? 'Show Links' : 'Hide Links';
                            linksContainer.style.display = isExpanded ? 'none' : 'block';
                        });
                        
                        // Add components to entry row
                        entryRow.appendChild(meta);
                        entryRow.appendChild(pathInfo);
                        entryRow.appendChild(campaignElem);
                        entryRow.appendChild(expandBtn);
                        entryRow.appendChild(linksContainer);
                        
                        // Add entry to domain entries container
                        entriesContainer.appendChild(entryRow);
                    });
                    
                    // Add entries container to domain section
                    domainSection.appendChild(entriesContainer);
                    
                    // Add domain section to domains container
                    domainsContainer.appendChild(domainSection);
                });
                
                // Add domains container to history content
                historyContent.appendChild(domainsContainer);
                
                // Automatically open history when displaying new content
                autoOpenHistory();
            }
            
            function clearHistory() {
                if (confirm('Are you sure you want to clear your link history? This action cannot be undone.')) {
                    localStorage.removeItem('utmLinkHistory');
                    displayHistory();
                }
            }
            
            // Toggle history visibility function
            function toggleHistory() {
                historyContent.classList.toggle('open');
            }
            
            // Auto-open history when history is displayed
            function autoOpenHistory() {
                historyContent.classList.add('open');
            }
            
            // Reset form function
            function resetForm() {
                // Reset the form by showing it again
                formEl.style.display = 'block';
                
                // Reset any checkboxes that might be checked
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Clear results and error messages
                resultsDiv.innerHTML = '';
                errorDiv.innerHTML = '';
                
                // Set focus back to the URL input for accessibility
                baseUrlInput.focus();
            }
            
            // Handle form submission via Enter key
            formEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    generateLinks();
                }
            });
            
            // Initialize event listeners
            generateBtn.addEventListener('click', generateLinks);
            historyHeader.addEventListener('click', toggleHistory);
            clearHistoryBtn.addEventListener('click', clearHistory);
            
            // Initialize history display on load
            displayHistory();
            
            // Validate URL
            function isValidUrl(url) {
                try {
                    const testUrl = url.startsWith('http') ? url : 'https://' + url;
                    const urlObj = new URL(testUrl);
                    // Make sure it has a valid domain
                    return urlObj.hostname.includes('.');
                } catch (e) {
                    return false;
                }
            }
            
            // Format UTM parameter
            function formatUtmParam(str) {
                if (!str) return '';
                return str.toLowerCase()
                    .replace(/\s+/g, '_')     // Replace spaces with underscore
                    .replace(/[^\w-]/g, '')   // Remove non-alphanumeric, underscore, hyphen
                    .replace(/__+/g, '_')     // Replace multiple underscores with single
                    .replace(/^_|_$/g, '');   // Remove leading/trailing underscores
            }
            
            // Check if URL has UTM parameters
            function hasUtmParameters(urlString) {
                try {
                    const url = new URL(urlString);
                    // Check for any UTM parameter using RegExp pattern
                    return Array.from(url.searchParams.keys()).some(key => /^utm_/.test(key));
                } catch (e) {
                    // Fallback to regex check if URL parsing fails
                    return /[?&]utm_/.test(urlString);
                }
            }
            
            // Strip existing UTM parameters from URL
            function stripExistingUtmParams(urlString) {
                try {
                    const url = new URL(urlString);
                    const params = url.searchParams;
                    
                    // Get all parameter keys
                    const keys = Array.from(params.keys());
                    
                    // Remove all UTM parameters
                    keys.forEach(key => {
                        if (key.startsWith('utm_')) {
                            params.delete(key);
                        }
                    });
                    
                    // Reconstruct the URL without UTM parameters
                    url.search = params.toString();
                    return url.toString();
                } catch (e) {
                    console.error('Error stripping UTM params:', e);
                    
                    // Fallback to regex-based removal if URL parsing fails
                    let cleanUrl = urlString;
                    
                    // Remove utm parameters with regex
                    const utmRegex = /([&?])(utm_source|utm_medium|utm_campaign|utm_term|utm_content|utm_id)=[^&]*(&|$)/g;
                    
                    // First pass - replace parameters in the middle or end with appropriate separator
                    cleanUrl = cleanUrl.replace(utmRegex, function(match, prefix, param, suffix) {
                        return suffix === '&' ? prefix : '';
                    });
                    
                    // Clean up any trailing ? or & characters
                    cleanUrl = cleanUrl.replace(/[?&]$/, '');
                    
                    // If we ended up with a ? followed immediately by a &, fix it
                    cleanUrl = cleanUrl.replace(/\?&/, '?');
                    
                    return cleanUrl;
                }
            }
            
            // Create a properly formatted URL with parameters
            function buildUrlWithParams(baseUrl, params) {
                // First strip any existing UTM parameters
                const cleanUrl = stripExistingUtmParams(baseUrl);
                
                // Parse the URL to handle parameters properly
                try {
                    const url = new URL(cleanUrl);
                    
                    // Add each parameter to the URL
                    Object.entries(params).forEach(([key, value]) => {
                        if (value) {
                            url.searchParams.append(key, value);
                        }
                    });
                    
                    return url.toString();
                } catch (e) {
                    console.error('Error building URL:', e);
                    // Fallback to manual parameter handling
                    let urlString = cleanUrl;
                    
                    // Check if URL already has parameters
                    const hasParams = urlString.includes('?');
                    let paramPrefix = hasParams ? '&' : '?';
                    
                    // Add parameters
                    Object.entries(params).forEach(([key, value], index) => {
                        if (value) {
                            urlString += `${paramPrefix}${key}=${encodeURIComponent(value)}`;
                            paramPrefix = '&';
                        }
                    });
                    
                    return urlString;
                }
            }
            
            // Generate UTM links
            function generateLinks() {
                // Clear previous results and errors
                resultsDiv.innerHTML = '';
                errorDiv.innerHTML = '';
                
                // Validate inputs
                let errors = [];
                
                // Check URL
                const baseUrl = baseUrlInput.value.trim();
                if (!baseUrl) {
                    errors.push('Please enter a website URL');
                } else if (!isValidUrl(baseUrl)) {
                    errors.push('Please enter a valid URL');
                }
                
                // Check if at least one publication is selected
                const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
                if (selectedCheckboxes.length === 0) {
                    errors.push('Please select at least one publication');
                }
                
                // Display errors if any
                if (errors.length > 0) {
                    errorDiv.innerHTML = errors.map(err => `<p>${err}</p>`).join('');
                    return;
                }
                
                // Hide form for better viewing of results
                formEl.style.display = 'none';
                
                // Format the base URL
                let formattedBaseUrl = baseUrl;
                if (!formattedBaseUrl.startsWith('http')) {
                    formattedBaseUrl = 'https://' + formattedBaseUrl;
                }
                
                // Remove trailing slash if present (for cleaner URLs)
                if (formattedBaseUrl.endsWith('/')) {
                    formattedBaseUrl = formattedBaseUrl.slice(0, -1);
                }
                
                // Get campaign, term, and content values
                const campaign = formatUtmParam(campaignInput.value);
                const term = formatUtmParam(termInput.value);
                const content = formatUtmParam(contentInput.value);
                
                // Generate a link for each selected publication
                const generatedUrls = [];
                
                selectedCheckboxes.forEach(checkbox => {
                    const source = checkbox.id;
                    const medium = checkbox.dataset.medium || 'referral';
                    const publication = checkbox.nextElementSibling.textContent;
                    
                    // Build UTM URL with parameters
                    const utmParams = {
                        'utm_source': source,
                        'utm_medium': medium
                    };
                    
                    // Add optional parameters if present
                    if (campaign) utmParams['utm_campaign'] = campaign;
                    if (term) utmParams['utm_term'] = term;
                    if (content) utmParams['utm_content'] = content;
                    
                    const utmUrl = buildUrlWithParams(formattedBaseUrl, utmParams);
                    
                    generatedUrls.push({
                        publication,
                        source,
                        medium,
                        url: utmUrl
                    });
                });
                
                // Add a "Create New Links" button at the top
                const newLinksBtn = document.createElement('button');
                newLinksBtn.textContent = 'Create New Links';
                newLinksBtn.className = 'reset-btn';
                newLinksBtn.setAttribute('aria-label', 'Create new UTM links');
                newLinksBtn.addEventListener('click', resetForm);
                
                resultsDiv.appendChild(newLinksBtn);
                
                // Check if URL has existing UTM parameters and notify user
                if (hasUtmParameters(formattedBaseUrl)) {
                    const notification = document.createElement('p');
                    notification.className = 'utm-warning';
                    notification.innerHTML = '<strong>Note:</strong> Existing UTM parameters were detected and removed from your URL.';
                    resultsDiv.appendChild(notification);
                }
                
                // Display results
                if (generatedUrls.length > 0) {
                    const resultsHeader = document.createElement('h2');
                    resultsHeader.textContent = 'Generated URLs';
                    resultsDiv.appendChild(resultsHeader);
                    
                    // Only show "Copy All" button if there are multiple URLs
                    if (generatedUrls.length > 1) {
                        const copyAllBtn = document.createElement('button');
                        copyAllBtn.textContent = 'Copy All URLs';
                        copyAllBtn.className = 'copy-all-btn';
                        copyAllBtn.setAttribute('aria-label', 'Copy all generated URLs to clipboard');
                        copyAllBtn.addEventListener('click', function() {
                            const allUrls = generatedUrls.map(item => item.url).join('\n\n');
                            copyToClipboard(allUrls, this);
                        });
                        resultsDiv.appendChild(copyAllBtn);
                    }
                    
                    // Create results container
                    const resultsContainer = document.createElement('div');
                    resultsContainer.className = 'results-container';
                    
                    // Create a result for each channel
                    generatedUrls.forEach(item => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result';
                        
                        // Clean up publication name (remove any notes in parentheses)
                        let pubName = item.publication;
                        if (pubName.includes('(')) {
                            pubName = pubName.substring(0, pubName.indexOf('(')).trim();
                        }
                        
                        const pubHeader = document.createElement('h3');
                        pubHeader.textContent = pubName;
                        
                        const sourceInfo = document.createElement('p');
                        sourceInfo.innerHTML = `<strong>Source:</strong> ${item.source}, <strong>Medium:</strong> ${item.medium}`;
                        
                        const urlContainer = document.createElement('div');
                        urlContainer.style.display = 'flex';
                        urlContainer.style.alignItems = 'center';
                        urlContainer.className = 'url-container';
                        
                        const urlText = document.createElement('input');
                        urlText.type = 'text';
                        urlText.value = item.url;
                        urlText.readOnly = true;
                        urlText.className = 'url-input';
                        urlText.setAttribute('aria-label', `URL for ${pubName}`);
                        
                        // Add click handler to select all text
                        urlText.addEventListener('click', function() {
                            this.select();
                        });
                        
                        const copyBtn = document.createElement('button');
                        copyBtn.textContent = 'Copy';
                        copyBtn.className = 'copy-btn';
                        copyBtn.setAttribute('aria-label', `Copy URL for ${pubName} to clipboard`);
                        copyBtn.addEventListener('click', function() {
                            copyToClipboard(item.url, this);
                        });
                        
                        urlContainer.appendChild(urlText);
                        urlContainer.appendChild(copyBtn);
                        
                        resultDiv.appendChild(pubHeader);
                        resultDiv.appendChild(sourceInfo);
                        resultDiv.appendChild(urlContainer);
                        
                        resultsContainer.appendChild(resultDiv);
                    });
                    
                    resultsDiv.appendChild(resultsContainer);
                    
                    // Save generated links to history
                    saveToHistory(generatedUrls);
                }
            }
        });
    </script>
</body>
</html>
